name: Generate Org Stats

on:
  schedule:
    - cron: '0 0 * * *' # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å
  workflow_dispatch:

jobs:
  build-org-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          sudo apt update && sudo apt install -y jq curl

      - name: –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–± –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORG="DiametrEDU"
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/orgs/$ORG/repos?per_page=100" > repos.json

          # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —è–∑—ã–∫–∞–º
          declare -A languages
          for repo in $(jq -r '.[].name' repos.json); do
            curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$ORG/$repo/languages" > lang.json
            for lang in $(jq -r 'keys[]' lang.json); do
              bytes=$(jq ".\"$lang\"" lang.json)
              ((languages[$lang]+=$bytes))
            done
          done

          # –§–æ—Ä–º–∏—Ä—É–µ–º SVG
          echo "<svg width=\"600\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\">" > org-stats.svg
          echo "<style>text { font: 14px sans-serif; }</style>" >> org-stats.svg
          echo "<text x=\"0\" y=\"15\">üåê –Ø–∑—ã–∫–∏ DiametrEDU: " >> org-stats.svg

          X=160
          for lang in "${!languages[@]}"; do
            echo "<tspan dx=\"10\">$lang (${languages[$lang]} bytes)</tspan>" >> org-stats.svg
          done

          echo "</text></svg>" >> org-stats.svg

      - name: –ö–æ–º–º–∏—Ç –∏ –ø—É—à SVG
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add org-stats.svg
          git commit -m "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ org-stats.svg (—è–∑—ã–∫–∏)" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          git push
